{% extends 'base.html' %}

{% block title %}Editar Paciente{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0">
                    <i class="bi bi-person-lines-fill"></i> Editar Paciente
                </h3>
            </div>
            <div class="card-body">
                <form method="POST" id="pacienteForm">
                    {% csrf_token %}
                    
                    <!-- Datos básicos del paciente -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label">
                                    {{ form.nombre.label }}
                                </label>
                                {{ form.nombre }}
                                {% if form.nombre.errors %}
                                    <div class="text-danger">
                                        {{ form.nombre.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.apellido.id_for_label }}" class="form-label">
                                    {{ form.apellido.label }}
                                </label>
                                {{ form.apellido }}
                                {% if form.apellido.errors %}
                                    <div class="text-danger">
                                        {{ form.apellido.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">
                                    {{ form.tipo_documento.label }}
                                </label>
                                {{ form.tipo_documento }}
                                {% if form.tipo_documento.errors %}
                                    <div class="text-danger">
                                        {{ form.tipo_documento.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                                    {{ form.numero_documento.label }}
                                </label>
                                {{ form.numero_documento }}
                                {% if form.numero_documento.errors %}
                                    <div class="text-danger">
                                        {{ form.numero_documento.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                                    {{ form.fecha_nacimiento.label }}
                                </label>
                                {{ form.fecha_nacimiento }}
                                {% if form.fecha_nacimiento.errors %}
                                    <div class="text-danger">
                                        {{ form.fecha_nacimiento.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.genero.id_for_label }}" class="form-label">
                                    {{ form.genero.label }}
                                </label>
                                {{ form.genero }}
                                {% if form.genero.errors %}
                                    <div class="text-danger">
                                        {{ form.genero.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    {{ form.email.label }}
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger">
                                        {{ form.email.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <!-- Sección de Direcciones -->
                    <h5><i class="bi bi-geo-alt"></i> Direcciones</h5>
                    <div id="direccion-formset">
                        {{ direccion_formset.management_form }}
                        {% for direccion_form in direccion_formset %}
                            <div class="direccion-form mb-3 p-3 border rounded position-relative">
                                {% for hidden in direccion_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <label class="form-label">País</label>
                                            <select class="form-control mb-2 pais-select" 
                                                    data-departamento-url="{% url 'pacientes:cargar_departamentos' %}">
                                                <option value="">Seleccione un país</option>
                                                {% for pais in paises %}
                                                    <option value="{{ pais.id }}" {% if direccion_form.instance.ciudad and direccion_form.instance.ciudad.departamento.pais.id == pais.id %}selected{% endif %}>{{ pais.nombre }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <label class="form-label">Departamento</label>
                                            <select class="form-control mb-2 departamento-select" 
                                                    data-ciudad-url="{% url 'pacientes:cargar_ciudades' %}">
                                                <option value="">Seleccione un departamento</option>
                                                {% if direccion_form.instance.ciudad %}
                                                    {% for depto in direccion_form.instance.ciudad.departamento.pais.departamento_set.all %}
                                                        <option value="{{ depto.id }}" {% if direccion_form.instance.ciudad.departamento.id == depto.id %}selected{% endif %}>{{ depto.nombre }}</option>
                                                    {% endfor %}
                                                {% endif %}
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <label for="{{ direccion_form.ciudad.id_for_label }}" class="form-label">
                                                {{ direccion_form.ciudad.label }}
                                            </label>
                                            {{ direccion_form.ciudad }}
                                            {% if direccion_form.ciudad.errors %}
                                                <div class="text-danger">
                                                    {{ direccion_form.ciudad.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="mb-2">
                                            <label for="{{ direccion_form.direccion.id_for_label }}" class="form-label">
                                                {{ direccion_form.direccion.label }}
                                            </label>
                                            {{ direccion_form.direccion }}
                                            {% if direccion_form.direccion.errors %}
                                                <div class="text-danger">
                                                    {{ direccion_form.direccion.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-2">
                                            <label for="{{ direccion_form.codigo_postal.id_for_label }}" class="form-label">
                                                {{ direccion_form.codigo_postal.label }}
                                            </label>
                                            {{ direccion_form.codigo_postal }}
                                            {% if direccion_form.codigo_postal.errors %}
                                                <div class="text-danger">
                                                    {{ direccion_form.codigo_postal.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-check mb-2">
                                    {{ direccion_form.es_principal }}
                                    <label for="{{ direccion_form.es_principal.id_for_label }}" class="form-check-label">
                                        {{ direccion_form.es_principal.label }}
                                    </label>
                                </div>
                                
                                {% if direccion_form.DELETE %}
                                    <div class="form-check">
                                        {{ direccion_form.DELETE }}
                                        <label for="{{ direccion_form.DELETE.id_for_label }}" class="form-check-label text-danger">
                                            Eliminar esta dirección
                                        </label>
                                    </div>
                                {% endif %}
                                
                                {% if direccion_form.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {{ direccion_form.non_field_errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    <hr>
                    
                    <!-- Sección de Teléfonos -->
                    <h5><i class="bi bi-telephone"></i> Teléfonos</h5>
                    <div id="telefono-formset">
                        {{ telefono_formset.management_form }}
                        {% for telefono_form in telefono_formset %}
                            <div class="telefono-form mb-3 p-3 border rounded position-relative">
                                {% for hidden in telefono_form.hidden_fields %}
                                    {{ hidden }}
                                {% endfor %}
                                
                                <div class="row">
                                    <div class="col-md-5">
                                        <div class="mb-2">
                                            <label for="{{ telefono_form.tipo_telefono.id_for_label }}" class="form-label">
                                                {{ telefono_form.tipo_telefono.label }}
                                            </label>
                                            {{ telefono_form.tipo_telefono }}
                                            {% if telefono_form.tipo_telefono.errors %}
                                                <div class="text-danger">
                                                    {{ telefono_form.tipo_telefono.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-5">
                                        <div class="mb-2">
                                            <label for="{{ telefono_form.numero.id_for_label }}" class="form-label">
                                                {{ telefono_form.numero.label }}
                                            </label>
                                            {{ telefono_form.numero }}
                                            {% if telefono_form.numero.errors %}
                                                <div class="text-danger">
                                                    {{ telefono_form.numero.errors }}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-2">
                                        <div class="form-check mt-4">
                                            {{ telefono_form.es_principal }}
                                            <label for="{{ telefono_form.es_principal.id_for_label }}" class="form-check-label">
                                                {{ telefono_form.es_principal.label }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                {% if telefono_form.DELETE %}
                                    <div class="form-check">
                                        {{ telefono_form.DELETE }}
                                        <label for="{{ telefono_form.DELETE.id_for_label }}" class="form-check-label text-danger">
                                            Eliminar este teléfono
                                        </label>
                                    </div>
                                {% endif %}
                                
                                {% if telefono_form.non_field_errors %}
                                    <div class="alert alert-danger">
                                        {{ telefono_form.non_field_errors }}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                    
                    <button type="button" id="agregar-telefono" class="btn btn-outline-primary btn-sm mb-3">
                        <i class="bi bi-plus-circle"></i> Agregar otro teléfono
                    </button>
                    
                    <button type="button" id="eliminar-telefono" class="btn btn-outline-danger btn-sm mb-3 mx-2">
                        <i class="bi bi-trash"></i> Eliminar último teléfono agregado
                    </button>
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'pacientes:show' paciente.id %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Actualizar Paciente
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Función para cargar opciones en selects dinámicamente
function cargarOpciones(select, url, datos) {
    $.ajax({
        url: url,
        data: datos,
        success: function(data) {
            select.html(data);
        }
    });
}

$(document).ready(function() {
    // Manejar cambio de país para cargar departamentos
    $(document).on('change', '.pais-select', function() {
        var paisId = $(this).val();
        var departamentoSelect = $(this).closest('.direccion-form').find('.departamento-select');
        var ciudadSelect = $(this).closest('.direccion-form').find('.ciudad-select');
        
        if (paisId) {
            var url = $(this).data('departamento-url');
            cargarOpciones(departamentoSelect, url, {'pais_id': paisId});
            ciudadSelect.html('<option value="">Seleccione una ciudad</option>');
        } else {
            departamentoSelect.html('<option value="">Seleccione un departamento</option>');
            ciudadSelect.html('<option value="">Seleccione una ciudad</option>');
        }
    });
    
    // Manejar cambio de departamento para cargar ciudades
    $(document).on('change', '.departamento-select', function() {
        var departamentoId = $(this).val();
        var ciudadSelect = $(this).closest('.direccion-form').find('.ciudad-select');
        
        if (departamentoId) {
            var url = $(this).data('ciudad-url');
            cargarOpciones(ciudadSelect, url, {'departamento_id': departamentoId});
        } else {
            ciudadSelect.html('<option value="">Seleccione una ciudad</option>');
        }
    });
    
    // Agregar nuevo teléfono
    $('#agregar-telefono').click(function() {
        var formset = $('#telefono-formset');
        var formIdx = $('#id_telefono_set-TOTAL_FORMS').val();
        
        // Crear nuevo formulario
        var newForm = formset.find('.telefono-form').first().clone();
        newForm.find('input,select,textarea').each(function() {
            var name = $(this).attr('name').replace('-0-', '-' + formIdx + '-');
            var id = $(this).attr('id').replace('_0_', '_' + formIdx + '_');
            $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
        });
        newForm.find('label').each(function() {
            var newFor = $(this).attr('for').replace('_0_', '_' + formIdx + '_');
            $(this).attr('for', newFor);
        });
        
        // Añadir el nuevo formulario
        formset.append(newForm);
        
        // Incrementar el contador de formularios
        $('#id_telefono_set-TOTAL_FORMS').val(parseInt(formIdx) + 1);
    });
    
    // Eliminar último teléfono agregado
    $('#eliminar-telefono').click(function() {
        var formset = $('#telefono-formset');
        var totalForms = $('#id_telefono_set-TOTAL_FORMS');
        var formCount = parseInt(totalForms.val());
        var initialForms = parseInt($('#id_telefono_set-INITIAL_FORMS').val());
        
        // Solo eliminar si hay más formularios de los iniciales
        if (formCount > initialForms) {
            // Eliminar el último formulario agregado
            formset.find('.telefono-form').last().remove();
            
            // Decrementar el contador de formularios
            totalForms.val(formCount - 1);
        } else {
            alert('No hay teléfonos adicionales para eliminar.');
        }
    });
    
    // Configurar valores por defecto para UNEARTE (Venezuela)
    setTimeout(function() {
        $('.pais-select').each(function() {
            var $this = $(this);
            // Seleccionar Venezuela automáticamente si no hay otro valor
            if (!$this.val()) {
                $this.find('option').each(function() {
                    if ($(this).text() === 'Venezuela') {
                        $this.val($(this).val()).trigger('change');
                    }
                });
            }
        });
    }, 500);
});
</script>
{% endblock %}